name: Deploy Element Web to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout chat repo
        uses: actions/checkout@v4

      - name: Checkout Element Web
        uses: actions/checkout@v4
        with:
          repository: element-hq/element-web
          path: element-web

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Element Web uses Yarn for its monorepo and requires Node 22+

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        working-directory: element-web
        run: yarn install --frozen-lockfile

      - name: Copy custom config
        run: |
          cp public/config.json element-web/config.json

      - name: Build Element Web
        working-directory: element-web
        run: |
          yarn build

      - name: Add redirect and guest access script to Element Web index.html
        run: |
          # Add script to automatically login as guest and join room
          python3 << 'PYTHON_SCRIPT'
          import re
          
          with open('element-web/webapp/index.html', 'r') as f:
              content = f.read()
          
          # Script to automatically login as guest and initialize Element
          guest_script = '''<script>
          (function() {
            // Check if already logged in
            const mxAccessToken = localStorage.getItem('mx_access_token') || 
                                 sessionStorage.getItem('mx_access_token') ||
                                 (() => {
                                   for(let i = 0; i < localStorage.length; i++) {
                                     const key = localStorage.key(i);
                                     if(key && key.includes('access_token')) {
                                       return localStorage.getItem(key);
                                     }
                                   }
                                   return null;
                                 })();
            
            if(mxAccessToken) {
              // Already logged in, redirect to room
              if(!window.location.hash || window.location.hash === "#" || window.location.hash === "#/") {
                window.location.hash = "#/room/%23lobby:inquiry.institute";
              }
              return;
            }
            
            // Auto-login as guest
            async function autoGuestLogin() {
              try {
                const response = await fetch('https://matrix.inquiry.institute/_matrix/client/v3/register?kind=guest', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: '{}'
                });
                
                if(response.ok) {
                  const creds = await response.json();
                  
                  // Store credentials - Element uses indexedDB and localStorage
                  // Store in multiple formats to ensure Element finds it
                  const baseUrl = 'https://matrix.inquiry.institute';
                  
                  // Format: mx_access_token:baseUrl:userId
                  localStorage.setItem(`mx_access_token:${baseUrl}:${creds.user_id}`, creds.access_token);
                  
                  // Also store in simple format
                  localStorage.setItem('mx_access_token', creds.access_token);
                  localStorage.setItem('mx_user_id', creds.user_id);
                  localStorage.setItem('mx_device_id', creds.device_id);
                  localStorage.setItem('mx_hs_url', baseUrl);
                  localStorage.setItem('mx_is_url', 'https://vector.im');
                  
                  // Store credentials object
                  localStorage.setItem('mx_credentials', JSON.stringify({
                    accessToken: creds.access_token,
                    userId: creds.user_id,
                    deviceId: creds.device_id,
                    homeServer: baseUrl
                  }));
                  
                  // Redirect to room
                  window.location.hash = "#/room/%23lobby:inquiry.institute";
                  // Small delay then reload to let Element initialize
                  setTimeout(() => {
                    window.location.reload();
                  }, 500);
                } else {
                  // Guest registration failed - try UI fallback
                  console.log('Auto guest login failed, using UI fallback');
                  redirectAndWaitForGuestButton();
                }
              } catch(e) {
                console.error('Auto guest login error:', e);
                redirectAndWaitForGuestButton();
              }
            }
            
            function redirectAndWaitForGuestButton() {
              // Redirect to room
              if(!window.location.hash || window.location.hash === "#" || window.location.hash === "#/") {
                window.location.hash = "#/room/%23lobby:inquiry.institute";
              }
              
              // Wait for Element to load and find guest button
              const tryClickGuest = () => {
                const selectors = [
                  '[data-testid="continue-as-guest"]',
                  'button[aria-label*="guest" i]',
                  'button[aria-label*="Continue as guest" i]',
                  '.mx_AccessibleButton[aria-label*="guest" i]',
                  'a[href*="guest"]',
                  'button:contains("Guest")'
                ];
                
                for(const sel of selectors) {
                  try {
                    const btn = document.querySelector(sel);
                    if(btn && !btn.disabled && btn.offsetParent !== null) {
                      btn.click();
                      return true;
                    }
                  } catch(e) {}
                }
                return false;
              };
              
              // Try immediately and on intervals
              if(!tryClickGuest()) {
                setTimeout(tryClickGuest, 1000);
                setTimeout(tryClickGuest, 3000);
                
                // Also observe DOM changes
                if(document.body) {
                  const observer = new MutationObserver(() => {
                    if(tryClickGuest()) {
                      observer.disconnect();
                    }
                  });
                  observer.observe(document.body, { childList: true, subtree: true });
                  
                  // Stop observing after 10 seconds
                  setTimeout(() => observer.disconnect(), 10000);
                }
              }
            }
            
            // Run immediately
            autoGuestLogin();
          })();
          </script>'''
          
          # Insert before </head>
          content = content.replace('</head>', f'{guest_script}\n</head>')
          
          with open('element-web/webapp/index.html', 'w') as f:
              f.write(content)
          PYTHON_SCRIPT

      - name: Copy CNAME for custom domain
        run: |
          if [ -f public/CNAME ]; then
            cp public/CNAME element-web/webapp/CNAME
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: element-web/webapp

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
