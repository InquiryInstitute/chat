name: Deploy Element Web to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout chat repo
        uses: actions/checkout@v4

      - name: Checkout Element Web
        uses: actions/checkout@v4
        with:
          repository: element-hq/element-web
          path: element-web

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Element Web uses Yarn for its monorepo and requires Node 22+

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        working-directory: element-web
        run: yarn install --frozen-lockfile

      - name: Copy custom config
        run: |
          cp public/config.json element-web/config.json

      - name: Build Element Web
        working-directory: element-web
        run: |
          yarn build

      - name: Add redirect and guest access script to Element Web index.html
        run: |
          # Add script to automatically login as guest and join room
          python3 << 'PYTHON_SCRIPT'
          import re
          
          with open('element-web/webapp/index.html', 'r') as f:
              content = f.read()
          
          # Script to automatically login as guest and navigate to room
          guest_script = '''<script>
          (function() {
            const TARGET_ROOM = "#/room/%23lobby:inquiry.institute";
            const BASE_URL = "https://matrix.inquiry.institute";
            
            // Check if already authenticated
            function hasAuthToken() {
              return localStorage.getItem('mx_access_token') || 
                     sessionStorage.getItem('mx_access_token') ||
                     (() => {
                       for(let i = 0; i < localStorage.length; i++) {
                         const key = localStorage.key(i);
                         if(key && (key.includes('access_token') || key.includes('matrix'))) {
                           return localStorage.getItem(key);
                         }
                       }
                       return null;
                     })();
            }
            
            // If already have token, just navigate
            if(hasAuthToken() && window.location.hash !== TARGET_ROOM) {
              window.location.hash = TARGET_ROOM;
              return;
            }
            
            // Register as guest
            async function registerGuest() {
              try {
                const response = await fetch(`${BASE_URL}/_matrix/client/v3/register?kind=guest`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: '{}'
                });
                
                if(response.ok) {
                  const creds = await response.json();
                  
                  // Store credentials in all formats Element might use
                  const credsToStore = {
                    'mx_access_token': creds.access_token,
                    'mx_user_id': creds.user_id,
                    'mx_device_id': creds.device_id,
                    'mx_hs_url': BASE_URL,
                    'mx_is_url': 'https://vector.im',
                    [`mx_access_token:${BASE_URL}:${creds.user_id}`]: creds.access_token
                  };
                  
                  // Store in localStorage and sessionStorage
                  for(const [key, value] of Object.entries(credsToStore)) {
                    localStorage.setItem(key, value);
                    sessionStorage.setItem(key, value);
                  }
                  
                  // Navigate to room
                  window.location.hash = TARGET_ROOM;
                  
                  // Reload after short delay to let Element initialize with credentials
                  setTimeout(() => window.location.reload(), 300);
                  
                  return true;
                }
              } catch(e) {
                console.error('Guest registration error:', e);
              }
              return false;
            }
            
            // Try to click "Explore room" link on welcome page
            function tryClickExploreRoom() {
              // Try multiple strategies to find the explore room link
              const strategies = [
                // Strategy 1: Direct selectors
                () => {
                  const links = document.querySelectorAll('a');
                  for(const link of links) {
                    const text = (link.textContent || '').trim().toLowerCase();
                    if(text.includes('explore') && (text.includes('room') || link.href)) {
                      return link;
                    }
                  }
                  return null;
                },
                // Strategy 2: Check href attributes
                () => {
                  const links = document.querySelectorAll('a[href]');
                  for(const link of links) {
                    if(link.href && (link.href.includes('room') || link.href.includes('#/room'))) {
                      return link;
                    }
                  }
                  return null;
                },
                // Strategy 3: Find by aria-label or data attributes
                () => {
                  return document.querySelector('a[aria-label*="explore" i], a[aria-label*="room" i]') ||
                         document.querySelector('[role="link"][href*="room"]');
                }
              ];
              
              for(const strategy of strategies) {
                try {
                  const link = strategy();
                  if(link && link.offsetParent !== null) {
                    // Found the link, click it
                    link.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => {
                      link.click();
                    }, 100);
                    return true;
                  }
                } catch(e) {
                  console.error('Error in explore room strategy:', e);
                }
              }
              
              return false;
            }
            
            // Wait for page to fully load, then try strategies
            function attemptGuestAccess() {
              // Strategy 1: Try guest registration
              registerGuest().then(success => {
                if(!success) {
                  // Strategy 2: If registration fails, try clicking "Explore room"
                  const attemptExplore = () => {
                    // Try immediately
                    if(tryClickExploreRoom()) return true;
                    
                    // If not found, wait a bit and try again
                    setTimeout(() => {
                      if(tryClickExploreRoom()) return true;
                      
                      // Last resort: navigate directly to room
                      window.location.hash = TARGET_ROOM;
                    }, 1500);
                    
                    return false;
                  };
                  
                  if(document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                      setTimeout(attemptExplore, 500);
                    });
                  } else {
                    setTimeout(attemptExplore, 500);
                  }
                }
              });
            }
            
            // Run immediately
            attemptGuestAccess();
            
            // Also monitor for welcome page and auto-navigate or click explore
            const checkAndNavigate = () => {
              const currentHash = window.location.hash;
              if(currentHash === '' || currentHash === '#' || currentHash === '#/' || currentHash === '#/welcome') {
                const token = hasAuthToken();
                if(token) {
                  // We have a token, navigate directly
                  window.location.hash = TARGET_ROOM;
                } else {
                  // No token yet, try clicking explore room
                  setTimeout(() => {
                    if(!tryClickExploreRoom()) {
                      // If clicking fails, navigate anyway
                      window.location.hash = TARGET_ROOM;
                    }
                  }, 500);
                }
              }
            };
            
            // Check periodically (every 1 second) and on hash change
            setInterval(checkAndNavigate, 1000);
            window.addEventListener('hashchange', checkAndNavigate);
            
            // Initial check after a short delay
            setTimeout(checkAndNavigate, 500);
          })();
          </script>'''
          
          # Insert before </head>
          content = content.replace('</head>', f'{guest_script}\n</head>')
          
          with open('element-web/webapp/index.html', 'w') as f:
              f.write(content)
          PYTHON_SCRIPT

      - name: Copy CNAME for custom domain
        run: |
          if [ -f public/CNAME ]; then
            cp public/CNAME element-web/webapp/CNAME
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: element-web/webapp

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
