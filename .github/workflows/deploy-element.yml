name: Deploy Element Web to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout chat repo
        uses: actions/checkout@v4

      - name: Checkout Element Web
        uses: actions/checkout@v4
        with:
          repository: element-hq/element-web
          path: element-web

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Element Web uses Yarn for its monorepo and requires Node 22+

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        working-directory: element-web
        run: yarn install --frozen-lockfile

      - name: Copy custom config
        run: |
          cp public/config.json element-web/config.json

      - name: Build Element Web
        working-directory: element-web
        run: |
          yarn build

      - name: Add redirect and guest access script to Element Web index.html
        run: |
          # Add script to automatically login as guest and join room, plus CSS to collapse left panel
          python3 << 'PYTHON_SCRIPT'
          import re
          
          with open('element-web/webapp/index.html', 'r') as f:
              content = f.read()
          
          # CRITICAL: Set initial hash immediately - before ANY other scripts
          # This must be the very first thing that runs
          immediate_hash_setter = '''<script>
          (function() {
            // IMMEDIATE execution - no waiting
            const TARGET_ROOM = '#/room/!ZyUMuZyXZnnSvkkfwE:inquiry.institute';
            
            // Set hash IMMEDIATELY before anything else can redirect
            if (!window.location.hash || 
                window.location.hash === '#' || 
                window.location.hash.startsWith('#/welcome') ||
                window.location.hash.startsWith('#/login') ||
                window.location.href.includes('matrix.to')) {
              window.location.hash = TARGET_ROOM;
            }
            
            // Also block location.href SETTER at the earliest possible moment
            const originalHrefDescriptor = Object.getOwnPropertyDescriptor(window.location, 'href');
            if (originalHrefDescriptor && originalHrefDescriptor.set) {
              Object.defineProperty(window.location, 'href', {
                set: function(url) {
                  if (url && (url.includes('matrix.to') || url.includes('app.element.io'))) {
                    console.log('[IMMEDIATE BLOCK] Prevented redirect to:', url);
                    originalHrefDescriptor.set.call(window.location, window.location.origin + window.location.pathname + TARGET_ROOM);
                    return;
                  }
                  originalHrefDescriptor.set.call(window.location, url);
                },
                get: function() {
                  return originalHrefDescriptor.get ? originalHrefDescriptor.get.call(window.location) : window.location.href;
                },
                configurable: true
              });
            }
          })();
          </script>'''
          
          # CSS to collapse left panel by default
          collapse_css = '''<style>
          /* Collapse left panel by default */
          [aria-label="Spaces"] ~ div[class*="LeftPanel"],
          [data-testid="left-panel"],
          .mx_LeftPanel,
          nav[aria-label="Spaces"] + div,
          .mx_LeftPanel.mx_LeftPanel_collapsed,
          /* Try to find and hide the left sidebar container */
          body > div > div > div:first-child > div:first-child {
            min-width: 64px !important;
            width: 64px !important;
            max-width: 64px !important;
            flex-basis: 64px !important;
          }
          /* Hide content but keep icons */
          .mx_LeftPanel [role="tree"],
          [aria-label="Spaces"] + div > div:not(:first-child),
          .mx_LeftPanel > div:not(:first-child) {
            opacity: 0 !important;
            pointer-events: none !important;
            width: 0 !important;
            overflow: hidden !important;
          }
          </style>'''
          
          # Script to automatically login as guest and navigate to room
          guest_script = '''<script>
          (function() {
          const TARGET_ROOM = "#/room/!ZyUMuZyXZnnSvkkfwE:inquiry.institute";
          const BASE_URL = "https://matrix.inquiry.institute";
          let guestRegistered = false;
          let navigationAttempted = false;
          
          // IMMEDIATE navigation - before anything else
          (function immediateNav() {
            const currentHash = window.location.hash;
            if (!currentHash || currentHash === '#' || currentHash === '#/' || currentHash === '#/welcome' || currentHash === '#/login') {
              window.location.hash = TARGET_ROOM;
              navigationAttempted = true;
            }
          })();
          
          // Check if already authenticated
          function hasAuthToken() {
            return localStorage.getItem('mx_access_token') || 
                   sessionStorage.getItem('mx_access_token') ||
                   (() => {
                     for(let i = 0; i < localStorage.length; i++) {
                       const key = localStorage.key(i);
                       if(key && (key.includes('access_token') || key.includes('matrix'))) {
                         return localStorage.getItem(key);
                       }
                     }
                     return null;
                   })();
          }
          
          // Register as guest immediately
          async function registerGuest() {
            if(guestRegistered) return true;
            
            try {
              const response = await fetch(`${BASE_URL}/_matrix/client/v3/register?kind=guest`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: '{}'
              });
              
              if(response.ok) {
                const creds = await response.json();
                guestRegistered = true;
                
                // Store credentials in all formats Element might use
                const credsToStore = {
                  'mx_access_token': creds.access_token,
                  'mx_user_id': creds.user_id,
                  'mx_device_id': creds.device_id,
                  'mx_hs_url': BASE_URL,
                  'mx_is_url': 'https://vector.im',
                  [`mx_access_token:${BASE_URL}:${creds.user_id}`]: creds.access_token
                };
                
                // Store in localStorage and sessionStorage
                for(const [key, value] of Object.entries(credsToStore)) {
                  localStorage.setItem(key, value);
                  sessionStorage.setItem(key, value);
                }
                
                // Force navigation immediately
                if(window.location.hash !== TARGET_ROOM) {
                  window.location.hash = TARGET_ROOM;
                }
                
                return true;
              }
            } catch(e) {
              console.error('Guest registration error:', e);
            }
            return false;
          }
          
          // Register guest immediately on page load
          registerGuest();
          
          // Aggressive navigation - force to room
          function forceNavigation() {
            const currentHash = window.location.hash;
            const isWelcomePage = !currentHash || currentHash === '#' || currentHash === '#/' || 
                                 currentHash === '#/welcome' || currentHash === '#/login' || 
                                 currentHash.startsWith('#/login');
            
            if(isWelcomePage && !navigationAttempted) {
              navigationAttempted = true;
              // Navigate immediately
              window.location.hash = TARGET_ROOM;
              
              // If we have a token, we're done
              if(hasAuthToken()) {
                return;
              }
              
              // If no token yet, try registering again
              registerGuest().then(() => {
                window.location.hash = TARGET_ROOM;
              });
            }
          }
          
          // Run immediately
          forceNavigation();
          
          // Watch for hash changes - redirect away from login/welcome
          window.addEventListener('hashchange', () => {
            const hash = window.location.hash;
            if (!hash || hash === '#' || hash === '#/' || hash === '#/welcome' || hash === '#/login' || hash.startsWith('#/login')) {
              window.location.hash = TARGET_ROOM;
            }
          });
          
          // Aggressive polling to catch any navigation to login/welcome
          setInterval(() => {
            const hash = window.location.hash;
            if (!hash || hash === '#' || hash === '#/' || hash === '#/welcome' || hash === '#/login' || hash.startsWith('#/login')) {
              window.location.hash = TARGET_ROOM;
            }
          }, 100);
          
          // Also intercept pushState/replaceState
          const originalPushState = history.pushState;
          const originalReplaceState = history.replaceState;
          
          history.pushState = function(...args) {
            originalPushState.apply(history, args);
            const hash = window.location.hash;
            if (!hash || hash === '#' || hash === '#/' || hash === '#/welcome' || hash === '#/login' || hash.startsWith('#/login')) {
              window.location.hash = TARGET_ROOM;
            }
          };
          
          history.replaceState = function(...args) {
            originalReplaceState.apply(history, args);
            const hash = window.location.hash;
            if (!hash || hash === '#' || hash === '#/' || hash === '#/welcome' || hash === '#/login' || hash.startsWith('#/login')) {
              window.location.hash = TARGET_ROOM;
            }
          };
          })();
          </script>'''
          
          # Add script to collapse left panel after Element loads
          collapse_script = '''<script>
          (function() {
            // Collapse left panel after Element loads
            function collapseLeftPanel() {
              // Wait for Element to fully load
              const checkInterval = setInterval(() => {
                // Try multiple selectors for the collapse button
                const collapseButtons = [
                  'button[aria-label*="Expand" i]',
                  'button[aria-label*="Collapse" i]',
                  '.mx_LeftPanel_collapse',
                  'button:has(svg[class*="chevron"])',
                  '[data-testid="collapse-left-panel"]'
                ];
                
                let collapseBtn = null;
                for(const selector of collapseButtons) {
                  try {
                    collapseBtn = document.querySelector(selector);
                    if(collapseBtn && collapseBtn.offsetParent !== null) {
                      break;
                    }
                  } catch(e) {}
                }
                
                // If panel is expanded (has tree content visible), collapse it
                const leftPanel = document.querySelector('[aria-label="Spaces"], .mx_LeftPanel');
                if(leftPanel) {
                  const tree = leftPanel.querySelector('[role="tree"]');
                  if(tree && tree.offsetWidth > 0) {
                    // Panel is expanded, try to collapse it
                    if(collapseBtn) {
                      collapseBtn.click();
                    } else {
                      // Force collapse via CSS
                      if(!leftPanel.classList.contains('mx_LeftPanel_collapsed')) {
                        leftPanel.classList.add('mx_LeftPanel_collapsed');
                      }
                    }
                    clearInterval(checkInterval);
                  }
                }
              }, 500);
              
              // Stop checking after 10 seconds
              setTimeout(() => clearInterval(checkInterval), 10000);
            }
            
            // Run when DOM is ready
            if(document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', collapseLeftPanel);
            } else {
              setTimeout(collapseLeftPanel, 1000);
            }
          })();
          </script>'''
          
          # Extract script content (remove <script> tags)
          guest_script_content = guest_script.replace('<script>', '').replace('</script>', '').strip()
          collapse_script_content = collapse_script.replace('<script>', '').replace('</script>', '').strip()
          
          # Create external script file to avoid CSP issues
          script_content = f'''{guest_script_content}
          {collapse_script_content}'''
          
          # Write to external file
          with open('element-web/webapp/guest-auto-login.js', 'w') as f:
              f.write(script_content)
          
          # Insert IMMEDIATE hash setter RIGHT AFTER <head> - before anything else
          if '<head>' in content:
              content = content.replace('<head>', '<head>\n' + immediate_hash_setter, 1)
          
          # Insert CSS before </head>
          content = content.replace('</head>', f'{collapse_css}\n</head>')
          
          # Insert external script reference before </head>
          external_script = '<script src="./guest-auto-login.js"></script>'
          content = content.replace('</head>', f'{external_script}\n</head>')
          
          # Add script to prevent redirects to app.element.io
          prevent_redirect_script = '''<script>
          // Prevent redirects to app.element.io and matrix.to
          (function() {
            const TARGET_ROOM = "#/room/!ZyUMuZyXZnnSvkkfwE:inquiry.institute";
            const originalReplace = window.location.replace;
            const originalAssign = window.location.assign;
            
            function shouldBlock(url) {
              return url && (url.includes('app.element.io') || url.includes('matrix.to'));
            }
            
            function redirectToRoom() {
              return window.location.origin + window.location.pathname + TARGET_ROOM;
            }
            
            window.location.replace = function(url) {
              if (shouldBlock(url)) {
                console.log('Blocked redirect to external site, redirecting to room instead');
                return originalReplace.call(window.location, redirectToRoom());
              }
              return originalReplace.apply(window.location, arguments);
            };
            
            window.location.assign = function(url) {
              if (shouldBlock(url)) {
                console.log('Blocked redirect to external site, redirecting to room instead');
                return originalAssign.call(window.location, redirectToRoom());
              }
              return originalAssign.apply(window.location, arguments);
            };
            
            // Also intercept window.open
            const originalOpen = window.open;
            window.open = function(url, target, features) {
              if (shouldBlock(url)) {
                console.log('Blocked window.open to external site');
                window.location.hash = TARGET_ROOM;
                return null;
              }
              return originalOpen.apply(window, arguments);
            };
            
            // Intercept clicks on matrix.to links
            document.addEventListener('click', function(e) {
              const link = e.target.closest('a[href]');
              if (link && link.href && link.href.includes('matrix.to')) {
                e.preventDefault();
                e.stopPropagation();
                const url = new URL(link.href);
                const hash = url.hash || url.pathname;
                if (hash.includes('lobby')) {
                  window.location.hash = TARGET_ROOM;
                } else {
                  // Extract room from matrix.to URL and navigate
                  const roomMatch = hash.match(/#([^:]+:[^/]+)/);
                  if (roomMatch) {
                    window.location.hash = '#/room/' + encodeURIComponent(roomMatch[1]);
                  } else {
                    window.location.hash = TARGET_ROOM;
                  }
                }
                return false;
              }
            }, true);
            
            // Also intercept beforeunload if trying to navigate to matrix.to
            window.addEventListener('beforeunload', function(e) {
              if (document.referrer && document.referrer.includes('matrix.to')) {
                // Don't allow navigation away if coming from matrix.to
                return;
              }
            });
          })();
          </script>'''
          
          # Insert BOTH immediate hash setter AND prevent redirect script RIGHT AFTER <head>
          # Combined script that runs immediately before anything else
          if '<head>' in content:
              # Combine both scripts - immediate hash setter first, then redirect blocker
              combined_scripts = immediate_hash_setter + '\n' + prevent_redirect_script
              content = content.replace('<head>', '<head>\n' + combined_scripts, 1)
          else:
              # Fallback: insert before external script
              combined_scripts = immediate_hash_setter + '\n' + prevent_redirect_script
              content = content.replace(external_script, combined_scripts + '\n' + external_script)
          
          with open('element-web/webapp/index.html', 'w') as f:
              f.write(content)
          PYTHON_SCRIPT

      - name: Copy CNAME for custom domain
        run: |
          if [ -f public/CNAME ]; then
            cp public/CNAME element-web/webapp/CNAME
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: element-web/webapp

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
