name: Deploy Element Web to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout chat repo
        uses: actions/checkout@v4

      - name: Checkout Element Web
        uses: actions/checkout@v4
        with:
          repository: element-hq/element-web
          path: element-web

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Element Web uses Yarn for its monorepo and requires Node 22+

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        working-directory: element-web
        run: yarn install --frozen-lockfile

      - name: Copy custom config
        run: |
          cp public/config.json element-web/config.json

      - name: Build Element Web
        working-directory: element-web
        run: |
          yarn build

      - name: Add redirect and guest access script to Element Web index.html
        run: |
          # Add script to automatically login as guest and join room
          python3 << 'PYTHON_SCRIPT'
          import re
          
          with open('element-web/webapp/index.html', 'r') as f:
              content = f.read()
          
          # Script to automatically login as guest and navigate to room
          guest_script = '''<script>
          (function() {
            // Immediately register as guest before Element loads
            async function registerGuestAndNavigate() {
              try {
                // Register as guest
                const response = await fetch('https://matrix.inquiry.institute/_matrix/client/v3/register?kind=guest', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: '{}'
                });
                
                if(response.ok) {
                  const creds = await response.json();
                  const baseUrl = 'https://matrix.inquiry.institute';
                  
                  // Store in all possible formats Element might use
                  const storageKeys = {
                    'mx_access_token': creds.access_token,
                    'mx_user_id': creds.user_id,
                    'mx_device_id': creds.device_id,
                    'mx_hs_url': baseUrl,
                    'mx_is_url': 'https://vector.im',
                    [`mx_access_token:${baseUrl}:${creds.user_id}`]: creds.access_token,
                    'mx_credentials': JSON.stringify({
                      accessToken: creds.access_token,
                      userId: creds.user_id,
                      deviceId: creds.device_id,
                      homeServer: baseUrl
                    })
                  };
                  
                  // Store in both localStorage and sessionStorage
                  for(const [key, value] of Object.entries(storageKeys)) {
                    localStorage.setItem(key, value);
                    sessionStorage.setItem(key, value);
                  }
                  
                  // Also try indexedDB if available (Element uses this)
                  if('indexedDB' in window) {
                    try {
                      const dbRequest = indexedDB.open('matrix-js-sdk:react-sdk', 1);
                      dbRequest.onsuccess = () => {
                        const db = dbRequest.result;
                        const tx = db.transaction(['keyvaluepairs'], 'readwrite');
                        const store = tx.objectStore('keyvaluepairs');
                        store.put(creds.access_token, `mx_access_token:${baseUrl}:${creds.user_id}`);
                      };
                    } catch(e) {}
                  }
                  
                  // Navigate directly to room - Element should detect the stored credentials
                  window.location.hash = "#/room/%23lobby:inquiry.institute";
                  
                  // Force reload to initialize Element with credentials
                  setTimeout(() => {
                    window.location.reload();
                  }, 100);
                } else {
                  // If guest registration fails, try clicking "Explore room"
                  console.log('Guest registration failed, trying Explore room');
                  setTimeout(() => {
                    const exploreLink = document.querySelector('a[href*="room"], a:contains("Explore")');
                    if(exploreLink) {
                      exploreLink.click();
                    } else {
                      // Navigate to room directly
                      window.location.hash = "#/room/%23lobby:inquiry.institute";
                    }
                  }, 2000);
                }
              } catch(e) {
                console.error('Guest registration error:', e);
                // Fallback: navigate to room and hope Element allows guest access
                window.location.hash = "#/room/%23lobby:inquiry.institute";
              }
            }
            
            // Run immediately - before Element initializes
            registerGuestAndNavigate();
            
            // Also listen for page load and try again if needed
            if(document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', () => {
                // Check if we're on welcome/login page and navigate to room
                if(window.location.hash === '' || window.location.hash === '#' || window.location.hash === '#/' || window.location.hash === '#/welcome') {
                  const token = localStorage.getItem('mx_access_token') || sessionStorage.getItem('mx_access_token');
                  if(token) {
                    // We have a token, force navigation to room
                    window.location.hash = "#/room/%23lobby:inquiry.institute";
                  }
                }
              });
            }
          })();
          </script>'''
          
          # Insert before </head>
          content = content.replace('</head>', f'{guest_script}\n</head>')
          
          with open('element-web/webapp/index.html', 'w') as f:
              f.write(content)
          PYTHON_SCRIPT

      - name: Copy CNAME for custom domain
        run: |
          if [ -f public/CNAME ]; then
            cp public/CNAME element-web/webapp/CNAME
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: element-web/webapp

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
